<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="https://blog.mattice.org/">
<meta name="description" content="Blog">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Deep in the weeds</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://blog.mattice.org/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/teasertest/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://blog.mattice.org/">

                <span id="blog-title">Deep in the weeds</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/teasertest/" class="u-url">teasertest</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Mike Mattice
            </span></p>
            <p class="dateline"><a href="posts/teasertest/" rel="bookmark"><time class="published dt-published" datetime="2016-05-02T15:33:15Z" title="2016-05-02 15:33">2016-05-02 15:33</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>Write your post here.</p>
<!-- TEASER_END

foo bar

adam apple -->
<p>baz</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/emvcos-response/" class="u-url">EMVCo's response</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Mike Mattice
            </span></p>
            <p class="dateline"><a href="posts/emvcos-response/" rel="bookmark"><time class="published dt-published" datetime="2016-05-02T15:13:33Z" title="2016-05-02 15:13">2016-05-02 15:13</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>A little more than a month later, I got a response from EMVCo to <a class="reference external" href="posts/emvco-request">my request</a>.  It's about what I expected.  I'm not sure they've read their own specification.</p>
<!-- TEASER_END -->
<!--  -->
<blockquote>
<p>Response:</p>
<p>Thank you for your query.</p>
<p>There is a slight difference between ISO and EMV tag coding. According to the EMV Book3 requirement, bit7 ~ bit1 of the first byte would not be part of tag number when these bits equals '11111', the tag number begins at the second byte in this case.</p>
<p>As the example tag "9F02", is an valid EMV tag, but not an ISO tag. This also means that you might consider the AIP and Amount, Authorised (numeric) to both have tag number 02; it is not helpful to refer to manage tags in this way, and hence EMV uses the full tag throughout.</p>
<p>Sincerely,</p>
<p>The EMVCo Secretariat</p>
<p>Message ID: 1007</p>
</blockquote>
<p>For starters, bit7 ~ bit1?  Suddenly it's grown a couple.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/quick-chip-emv/" class="u-url">Quick Chip EMV</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Mike Mattice
            </span></p>
            <p class="dateline"><a href="posts/quick-chip-emv/" rel="bookmark"><time class="published dt-published" datetime="2016-04-20T02:35:51Z" title="2016-04-20 02:35">2016-04-20 02:35</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>So Google Now cards notified me about Visa's "new" Quick Chip EMV spec today.  Apparently I've been profiled as someone interested in EMV.  Go figure.</p>
<p>From the <a class="reference external" href="https://www.visa.com/chip/merchants/grow-your-business/payment-technologies/credit-card-chip/docs/quick-chip-emv-specification.pdf">Quick Chip EMV Specification</a>:</p>
<blockquote>
<cite>Note: Using Quick Chip, the insertion, reading, and subsequent removal of the card may occur while the sales transaction is being rung up; i.e., before the final amount is known.</cite>
</blockquote>
<p>That's super cool!  It works much closer to the way a normal mag-stripe transaction would work in our stores.  Our customer service people do their thing while the customer does theirs in preparation for the end of the transaction and then the request happens as soon as the CS person is done and the customer verifies the amount.  This is much better than waiting for a response from the bank before you can pull your card.</p>
<p>Reading the specification, it seems that the terminal's EMV kernel tells the card "Yep, I can't go online, go ahead and give me stuff for a deferred authentication".  This will only work if the terminal is doing "Online" verification, which I'd guess most, if not all US retailers are doing with magstripe auths.</p>
<p>I started to wonder why Visa didn't come up with this years ago for everyone else that does EMV in the world. After reading the spec, it dawned on me.  This spec only works for <em>ONLINE</em> transactions.  The rest of the world used a lot of offline authentications because they've historically had to pay for individual phone calls and those communications were less reliable than the always online terminals the US has used for so many years.</p>
<p>One of the things that I find interesting is that Visa didn't bother fixing this problem 10 years ago for the UK.  Apparently the US consumer can't have anything get in the way of charging up their credit cards.</p>
<p>If we're back to a unidirectional communication from card to issuer, why wouldn't private keys loaded into something like <a class="reference external" href="http://onlycoin.com">Only Coin</a> work?  With some detection built in, it could rotate its magstripe every time it was swiped to the next rolling code, just like NFC based credit cards have done for a few years now.  The cards would be more expensive, but maybe not extremely so at scale, and we could all go back to "normal" swipes.  Just a thought.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/emvco-request/" class="u-url">EMVCo Request</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Mike Mattice
            </span></p>
            <p class="dateline"><a href="posts/emvco-request/" rel="bookmark"><time class="published dt-published" datetime="2016-04-14T04:01:08Z" title="2016-04-14 04:01">2016-04-14 04:01</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>I sent the following to EMVCo via <a class="reference external" href="https://www.emvco.com/PublicComments.aspx">https://www.emvco.com/PublicComments.aspx</a> on March 28th at about 0200UTC.</p>
<blockquote>
<p>Table 35 &amp; 36 refer to ISO/IEC 8825 which is also ITU-T Rec. X.690.  The X.690 spec available at <a class="reference external" href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf">https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf</a></p>
<p>Specifically, the document states "According to ISO/IEC 8825, Table 36 defines the coding rules of the subsequent bytes of a BER-TLV tag when tag numbers â‰¥ 31 are used (that is, bits b5 - b1 of the first byte equal '11111')."</p>
<p>Please explain how 9F02 follows this?  The tag number for 9F02 is 2, which is clearly &lt; 31.</p>
<dl class="docutils">
<dt>IEC/ISO 8255 states:</dt>
<dd>8.1.2.2 For tags with a number ranging from zero to 30 (inclusive), the identifier octets shall comprise a single octet encoded as follows:
a) bits 8 and 7 shall be encoded to represent the class of the tag as specified in Table 1;
b) bit 6 shall be a zero or a one according to the rules of 8.1.2.5;
c) bits 5 to 1 shall encode the number of the tag as a binary integer with bit 5 as the most significant bit.</dd>
</dl>
<p>That essentially tells me that every EMV tag that's two bytes with the second byte less than 31 is invalid and not capable of being encoded by BER.</p>
<p>I look forward to your response.</p>
</blockquote>
<p>I figure two weeks is plenty of time for them to respond to this simple inquiry.  Unfortunately, I got the only the following in response:</p>
<blockquote>
<p>*****Please do not reply to this email*****</p>
<p>Dear Mike Mattice,</p>
<p>Thank you for submitting your comment to EMVCo. EMVCo has received your comment and will review and respond as deemed necessary.</p>
<p>Please note that EMVCo does not guarantee a response to public comments. EMVCo has implemented a new subscriber program through its website in order to facilitate dialog and interaction between EMVCo and its subscriber community. For more details, please find the service description in the EMVCo website "Contact Us" section.</p>
<p>For your reference, a copy of your comment is included below.</p>
<p>Thank you.</p>
<p>The EMVCo Communication Secretariat
Message ID:1001</p>
<p><cite>-------------------</cite></p>
<p>Comment ID: 12005</p>
<p><cite>-------------------</cite></p>
</blockquote>
<p>Perhaps I should start a gofundme to become an EMVCo subscriber so I can get a guaranteed answer.</p>
<p>In other news I sent this to <a class="reference external" href="mailto:customerservice@iso.org">customerservice@iso.org</a>:</p>
<blockquote>
<p>Are there repercussions for claiming to follow ISO standards (like 8825) but not actually doing so?</p>
<p>Thanks,
Mike</p>
</blockquote>
<p>A couple days later I got:</p>
<blockquote>
<p>ISO standards are voluntary, and as such, ISO does not carry out any assessment of conformity, nor does it monitor the implementation of its standards.</p>
<p>A number of ISO standards - mainly those concerned with health, safety or the environment - have been adopted in some countries as part of their regulatory framework, or are referred to in legislation for which they serve as the technical basis. However, such adoptions are decisions by the regulatory authorities or governments of the countries concerned. ISO itself does not regulate or legislate.</p>
<p>Cordially,</p>
<p>joseph martinez</p>
<p>Information Expert | marketing and sales services | marketing, communication &amp; information | iso central secretariat | phone: +41 22 749 03 17</p>
</blockquote>
<p>So, no repercussions for saying you follow ISO-8825, but not actually doing so.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/asn1-and-emv/" class="u-url">ASN.1 and EMV</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Mike Mattice
            </span></p>
            <p class="dateline"><a href="posts/asn1-and-emv/" rel="bookmark"><time class="published dt-published" datetime="2016-03-27T23:41:16Z" title="2016-03-27 23:41">2016-03-27 23:41</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>I've been tasked with making EMV work for the company I work for and more importantly, for our customers.  As I write python most of the time these days, I looked around for a tool to play with <a class="reference external" href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf">ASN.1</a>.  A stupidly quick Google landed me on <a class="reference external" href="http://pyasn1.sf.net">pyasn1</a>.  I made a run at using it to manipulate the BER-TLV the <a class="reference external" href="https://www.emvco.com/download_agreement.aspx?id=654">EMV 4.3 Book 3</a> requires.  This resulted in some difficulties.  I reported a <a class="reference external" href="https://sourceforge.net/p/pyasn1/mailman/message/34776952/">bug</a> via the mailing list.</p>
<p>Thinks have changed in the past two months.</p>
<p>pyasn1 moved to <a class="reference external" href="https://github.com/etingof/pyasn1">github</a>.  I'd built some work arounds and submitted a <a class="reference external" href="https://github.com/etingof/pyasn1/pull/5">PR</a>.  I ended up splitting the PR into <a class="reference external" href="https://github.com/etingof/pyasn1/pull/6">another</a> because that one could break extended tags everywhere.  The issues I saw with the EMV tags and how they decoded are in that first PR, and also in <a class="reference external" href="https://github.com/mmattice/emv-asn1">emv-asn1</a>, which I wrote with my assumptions I'd codified in <a class="reference external" href="https://github.com/mmattice/pyasn1/tree/bugfix/emv">bugfix/emv</a>.</p>
<p>I did these things because I was sure EMVCo would surely stick to standards and that they had interpreted the ASN.1 spec correctly.  I now know I was wrong.</p>
<p>I've built, and am using, an internal version of pyasn1 and that allows me to encode/decode this EMV stuff 'properly'.  I've even made a decoder/encoder pair for our pinpad's odd text based format with these assumptions.</p>
<p>Now, however, I want to burn it all to the ground.</p>
<p>Today I found <a class="reference external" href="https://github.com/Shopify/grizzly_ber">grizzly_ber</a>, which is the same workaround in Ruby.  I realized it wasn't just me that was having trouble with this.</p>
<p>From <a class="reference external" href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf">ASN.1</a>:</p>
<blockquote>
<dl class="docutils">
<dt>8.1.2.2 For tags with a number ranging from zero to 30 (inclusive), the identifier octets shall comprise a single octet encoded as follows:</dt>
<dd><ol class="first last loweralpha simple">
<li>bits 8 and 7 shall be encoded to represent the class of the tag as specified in Table 1;</li>
<li>bit 6 shall be a zero or a one according to the rules of 8.1.2.5;</li>
<li>bits 5 to 1 shall encode the number of the tag as a binary integer with bit 5 as the most significant bit.</li>
</ol></dd>
</dl>
<p>8.1.2.4 For tags with a number greater than or equal to 31, the identifier shall comprise a leading octet followed by one or more subsequent octets.</p>
<dl class="docutils">
<dt>8.1.2.4.1 The leading octet shall be encoded as follows:</dt>
<dd><ol class="first last loweralpha simple">
<li>bits 8 and 7 shall be encoded to represent the class of the tag as listed in Table 1;</li>
<li>bit 6 shall be a zero or a one according to the rules of 8.1.2.5;</li>
<li>bits 5 to 1 shall be encoded as 11111.</li>
</ol></dd>
</dl>
</blockquote>
<p><a class="reference external" href="http://www.emvlab.org/emvtags/show/t82/">82</a> and <a class="reference external" href="http://www.emvlab.org/emvtags/show/t9f02">9F02</a> are an example of how EMVCo failed.  9F02 decodes to (80 + 1F) with a tag number of (02); 82 decodes to (80) tagno (02).  That 1F is only supposed to be there <strong>For tags with a number greater than or equal to 31</strong>.  The EMV standard even refers to the ASN.1 spec correctly in Book 3 Annex B1.</p>
<blockquote>
Table 36 defines the coding rules of the subsequent bytes of a BER-TLV tag when tag numbers â‰¥ 31 are used (that is, bits b5 - b1 of the first byte equal '11111').</blockquote>
<p>The EMV standard claims to use BER-TLV encoding.  It does not.  How can we fix this?  Is it fixable?  What's the right approach?</p>
<p>I personally like to do things "The Right Way".  Doing so would require billions of cards to be replaced and many instances of software to be updated.  I just don't see that happening any time soon.</p>
<p>I've <a class="reference external" href="https://www.emvco.com/PublicComments.aspx">asked</a> EMVCo how 9F** tags (and the rest of the extended tags) follow the standard they claim to follow.  I'm not guaranteed a response without <a class="reference external" href="https://www.emvco.com/about_emvco.aspx?id=161">subscribing for $2500</a>.  We'll see if I get a response.</p>
</div>
    </div>
    </article>
</div>







        </div>
        <!--End of body content-->

        <footer id="footer">
            Contents Â© 2016         <a href="mailto:mike.mattice+ditw@gmail.com">Mike Mattice</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76460414-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
